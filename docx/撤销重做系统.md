# 撤销重做系统使用说明

## 概述

已实现完整的撤销重做系统，支持至少 50 步历史记录，并提供快捷键支持。

## 已实现的功能

### 1. 历史记录管理 (`useHistory.ts`)

- **最大历史记录数量**: 50 步（可配置）
- **防抖延迟**: 300ms（可配置）
- **自动保存**: 状态变化时自动保存到历史记录
- **智能管理**: 撤销后进行新操作会清除"未来"的历史记录

### 2. 撤销重做工具栏 (`UndoRedoToolbar.tsx`)

- **撤销按钮**: 点击或按 `Ctrl+Z` 撤销上一步操作
- **重做按钮**: 点击或按 `Ctrl+Y` 或 `Ctrl+Shift+Z` 重做下一步操作
- **清除历史按钮**: 清除所有历史记录（可选显示）
- **按钮状态**: 根据是否可以撤销/重做自动禁用/启用按钮

### 3. 画布上下文集成 (`CanvasContextWithHistory.tsx`)

- **自动历史记录**: 图层操作自动保存到历史记录
- **状态恢复**: 撤销/重做时自动恢复画布状态
- **无缝集成**: 与现有的 `CanvasContext` 完全兼容

### 4. 文件导入导出 (`FileImportExport.tsx`)

- **图像导入**: 支持多文件导入，自动创建图层
- **单图层导出**: 导出当前选中的图层为 PNG
- **批量导出**: 导出所有图层为 PNG 序列
- **项目保存**: 保存整个项目为 JSON 文件
- **项目加载**: 从 JSON 文件加载项目

## 使用方法

### 方法 1: 使用带历史记录的 Provider（推荐）

如果要在整个应用中使用撤销重做功能，需要将 `CanvasProvider` 替换为 `CanvasProviderWithHistory`：

```tsx
import { CanvasProviderWithHistory } from './modules/canvas/composables/CanvasContextWithHistory';

function App() {
  return (
    <CanvasProviderWithHistory>
      {/* 你的应用组件 */}
      <MainCanvas />
    </CanvasProviderWithHistory>
  );
}
```

然后在任何组件中使用历史记录功能：

```tsx
import { useCanvasHistory } from './modules/canvas/composables/CanvasContextWithHistory';

function MyComponent() {
  const { canUndo, canRedo, undo, redo, clearHistory } = useCanvasHistory();
  
  return (
    <div>
      <button onClick={undo} disabled={!canUndo}>撤销</button>
      <button onClick={redo} disabled={!canRedo}>重做</button>
    </div>
  );
}
```

### 方法 2: 在 SmartPanel 中使用（已集成）

撤销重做工具栏已经集成到 `SmartPanel` 组件中，在 Stage A 模式下自动显示。

如果使用 `CanvasProviderWithHistory`，工具栏会自动启用。如果使用普通的 `CanvasProvider`，工具栏不会显示。

## 快捷键

- **撤销**: `Ctrl+Z` (Windows/Linux) 或 `Cmd+Z` (Mac)
- **重做**: `Ctrl+Y` (Windows/Linux) 或 `Cmd+Shift+Z` (Mac)

## 配置选项

在 `useHistory` Hook 中可以配置以下选项：

```tsx
const { saveHistory, undo, redo } = useHistory(state, setState, {
  maxHistorySize: 50,  // 最大历史记录数量
  debounceMs: 300      // 防抖延迟（毫秒）
});
```

## 注意事项

1. **性能优化**: 历史记录使用深拷贝保存状态，对于大型项目可能会占用较多内存
2. **防抖机制**: 连续的状态变化会被防抖合并，避免产生过多的历史记录
3. **自动保存**: 图层数量和选中状态变化时会自动保存历史记录
4. **状态恢复**: 撤销/重做时会重置整个画布状态，包括所有图层

## 文件导入导出使用

文件导入导出组件已集成到 `SmartPanel` 的 Stage A 模式中：

### 导入图像
1. 点击"导入"按钮
2. 选择一个或多个图像文件
3. 图像会自动创建为新图层

### 导出图层
1. 选择要导出的图层
2. 点击"导出当前图层"按钮
3. 图层会以 PNG 格式下载

### 导出所有图层
1. 点击"导出所有图层"按钮
2. 所有图层会依次下载为 PNG 文件

### 保存项目
1. 点击"保存项目"按钮
2. 项目会以 JSON 格式下载
3. 包含所有图层信息和画布状态

### 加载项目
1. 点击"加载项目"按钮
2. 选择之前保存的 JSON 文件
3. 项目会自动恢复所有图层和状态

## 下一步

要在应用中启用这些功能，需要：

1. 在 `App.tsx` 中将 `CanvasProvider` 替换为 `CanvasProviderWithHistory`
2. 确保 `SmartPanel` 组件已正确集成到主界面
3. 测试撤销重做功能是否正常工作
4. 测试文件导入导出功能是否正常工作

## 示例代码

完整的使用示例：

```tsx
import React from 'react';
import { CanvasProviderWithHistory, useCanvasHistory } from './modules/canvas/composables/CanvasContextWithHistory';
import { useCanvasContext } from './modules/canvas/composables/CanvasContext';
import { UndoRedoToolbar } from './modules/canvas/components/UndoRedoToolbar';
import { FileImportExport } from './modules/canvas/components/FileImportExport';

function MyCanvas() {
  const { state, dispatch } = useCanvasContext();
  const { canUndo, canRedo, undo, redo, clearHistory } = useCanvasHistory();
  
  return (
    <div>
      {/* 撤销重做工具栏 */}
      <UndoRedoToolbar
        canUndo={canUndo}
        canRedo={canRedo}
        onUndo={undo}
        onRedo={redo}
        onClear={clearHistory}
        showClear={true}
      />
      
      {/* 文件导入导出 */}
      <FileImportExport />
      
      {/* 你的画布内容 */}
      <div>
        {/* ... */}
      </div>
    </div>
  );
}

function App() {
  return (
    <CanvasProviderWithHistory>
      <MyCanvas />
    </CanvasProviderWithHistory>
  );
}

export default App;
```
