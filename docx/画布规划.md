# 精细抠图系统实现阶段文档

## 1. 项目概述

本项目旨在实现一个完整的精细抠图系统，包含四个主要阶段，从复杂背景分层到动画制作。系统采用现代化的前端架构，支持多层渲染、智能交互和动态属性面板。

## 2. 技术栈

- React 19
- TypeScript
- TanStack Query
- Shadcn UI
- 自定义 Canvas 渲染系统
- i18n 国际化支持



## 4. 实现阶段规划

### 4.1 阶段 1：语义封装与语言封装（当前阶段）

**目标**：建立基础组件系统和国际化支持

**任务列表**：

| 任务 | 状态 | 描述 |
|------|------|------|
| 1.4 | ✅ | 建立画布渲染系统基础架构 |
| 1.5 | ✅ | 将旧的三个画布升级细分为四个画布，保持现有布局不变 |

**实现细节**：

1. **语义化组件系统**：
   - 封装Button、Card、Slider等基础组件
   - 提供统一的样式接口


4. **画布系统升级**：
   - 将旧的三个画布升级细分为四个画布
   - 保持现有布局不变
   - 每个画布对应一个功能Stage
   - 启用新的画布命名
   - Canvas A (StageA)：复杂背景分层
   - Canvas B (StageB)：人物部位拆解
   - Canvas C (StageC)：骨骼绑定
   - Canvas D (StageD)：动画制作

### 4.2 阶段 2：Canvas A (StageA) - 复杂背景分层

**目标**：实现背景分解功能，支持智能框选和深度标记

**任务列表**：

| 任务 | 状态 | 描述 |
|------|------|------|
| 2.1 | ⏳ | 实现SAM智能框选功能 |
| 2.2 | ⏳ | 实现深度标记和Z-index管理 |
| 2.3 | ⏳ | 实现实时Inpainting功能 |
| 2.4 | ⏳ | 实现层级管理器 |

**实现细节**：

1. **SAM智能框选**：
   - 集成SAM模型，支持点击生成候选Mask
   - 实现Mask编辑和优化
   - 支持多对象同时框选

2. **深度标记**：
   - 实现Z-index分配和预览
   - 支持拖拽调整层级
   - 实现层级可视化

3. **实时Inpainting**：
   - 集成修复算法
   - 支持修复参数调整
   - 实现实时预览效果

4. **层级管理器**：
   - 实现层级列表展示
   - 支持拖拽排序、隐藏/显示、锁定
   - 实现层级导出功能

### 4.3 阶段 3：Canvas B (StageB) - 人物部位拆解

**目标**：实现人物部位分割和优化

**任务列表**：

| 任务 | 状态 | 描述 |
|------|------|------|
| 3.1 | ⏳ | 实现语义涂抹功能 |
| 3.2 | ⏳ | 实现边缘自动吸附 |
| 3.3 | ⏳ | 实现关节补全功能 |
| 3.4 | ⏳ | 实现部位预设和图层细分 |

**实现细节**：
   - 语义涂抹：不同颜色笔刷标记不同部位
   - 边缘自动吸附：SAM辅助修正笔刷边缘
   - 关节补全：自动生成圆滑的重叠像素
   - 部位预设：提供标准人形和动物模板
   - 图层细分属性：边缘羽化、扩张像素等

### 4.4 阶段 4：Canvas C (StageC) - 骨骼绑定

**目标**：实现骨骼创建和权重绑定

**任务列表**：

| 任务 | 状态 | 描述 |
|------|------|------|
| 4.1 | ⏳ | 实现骨骼绘制功能 |
| 4.2 | ⏳ | 实现权重可视化 |
| 4.3 | ⏳ | 实现IK链配置 |
| 4.4 | ⏳ | 实现骨骼层级管理 |

**实现细节**：
   - 骨骼绘制：创建关节点和骨骼
   - 权重可视化：热力图显示受影响区域
   - IK链配置：一键生成IK约束
   - 骨骼层级管理：父子关系和镜像对称
   - 权重编辑：画笔和自动权重计算

### 4.5 阶段 5：Canvas D (StageD) - 动画制作

**目标**：实现动画关键帧和时间轴

**任务列表**：

| 任务 | 状态 | 描述 |
|------|------|------|
| 5.1 | ⏳ | 实现姿态调整功能 |
| 5.2 | ⏳ | 实现关键帧记录 |
| 5.3 | ⏳ | 实现洋葱皮预览 |
| 5.4 | ⏳ | 实现动画剪辑管理 |

**实现细节**：
   - 姿态调整：IK/FK混合控制
   - 关键帧记录：自动插值
   - 洋葱皮预览：多帧幻影显示
   - 动画剪辑管理：创建和编辑动画
   - 关键帧插值：线性和贝塞尔曲线

## 5. 封装建议

### 5.1 组件封装

1. **语义化命名**：组件名称应反映其功能，如`CanvasBackground`、`InteractiveOverlay`
2. **单一职责**：每个组件只负责一项功能
3. **清晰的接口**：定义明确的Props和Events
4. **样式隔离**：使用CSS Modules或Tailwind CSS确保样式隔离
5. **可复用性**：设计通用组件，避免重复代码

### 5.2 状态管理

1. **分层状态**：使用不同的状态管理方案处理不同层级的状态
2. **Immutable更新**：使用不可变数据结构更新状态
3. **状态归一化**：确保状态结构清晰，易于维护
4. **性能优化**：使用React.memo和useMemo优化组件性能

### 5.3 语言封装

1. **统一翻译键格式**：使用点分隔的键名，如`precision-cut.sam-settings`
2. **支持多种语言**：至少支持中文、英文和日语
3. **动态加载**：支持按需加载语言资源
4. **上下文管理**：使用React Context提供翻译功能

## 6. 优化建议

### 6.1 性能优化

1. **虚拟渲染**：使用虚拟列表渲染大量图层
2. **离屏渲染**：对于复杂的Canvas操作，使用离屏Canvas
3. **缓存机制**：缓存计算结果，避免重复计算
4. **延迟加载**：按需加载组件和资源
5. **Web Workers**：将耗时操作移至Web Workers

### 6.2 开发体验优化

1. **TypeScript**：使用严格的TypeScript配置
2. **代码分割**：按功能模块分割代码
3. **单元测试**：为核心组件编写单元测试
4. **文档**：为组件和API编写详细文档
5. **开发工具**：集成React DevTools和Redux DevTools

### 6.3 用户体验优化

1. **流畅动画**：使用CSS transitions和animations实现流畅动画
2. **响应式设计**：适配不同屏幕尺寸
3. **键盘快捷键**：提供常用操作的键盘快捷键
4. **实时反馈**：操作后立即提供视觉反馈
5. **错误处理**：优雅处理错误，提供有用的错误信息

## 7. 总结

本实现阶段文档详细规划了精细抠图系统的开发流程，从语义封装和语言封装开始，逐步实现四个主要功能阶段。文档提供了清晰的架构设计、任务列表和实现细节，以及封装和优化建议，确保系统具有良好的可维护性、可扩展性和用户体验。

按照此文档的规划，我们将一步一步实现完整的精细抠图系统，满足用户的需求。

# 整体 UI 布局架构左侧工具栏 (Toolbar)：
 - 切换操作模式（点选、笔刷、骨骼、选择）。
 - 中间画布 (Main Canvas)：多层渲染系统，支持缩放、平移及模式特定的交互（SVG 骨骼层/Canvas 像素层）。
 - 右侧属性面板 (Smart Panel)：根据当前选中的 Stage 动态切换功能组件。
 - 底部面板 (Timeline/Console)：Stage A-C 显示任务状态，Stage D 切换为动画时间轴。

# Stage A: 复杂背景分层 (Scene Decomposition)
 - 此阶段的目标是将原图解构为具有深度关系的平面素材。
## 1. 画布交互
  - 智能框选：调用 SAM 生成候选 Mask。
  - 深度标记：为选中的对象分配 Z-index 预览效果。
  - 实时 Inpainting：点击“移除并修复”后，画布在当前层下方显示填充后的背景。
## 2. 右侧属性面板功能
### 层级管理器 (Layer Tree)：
   - 显示：[远景 | 中景 | 近景 | 主体] 的列表。
   - 操作：拖拽排序、隐藏/显示、锁定。
### 修复设置 (Inpaint Settings)：
   - 修复算法选择（Lama / SD Inpaint）。
   - 扩散步数 (Steps) 与 边缘扩张 (Padding) 像素调节。
### 导出选项：导出为多层 PSD 或独立 PNG 序列。

# Stage B: 人物部位拆解 (Character Part Splitting)
 - 此阶段将主体角色拆分为符合骨骼动画逻辑的散件。
## 1. 画布交互
  - 语义涂抹：使用不同颜色的笔刷为“头、手、腿”上色。
  - 边缘自动吸附：SAM 辅助修正笔刷边缘，确保部位分割精确。
  - 关节补全 (Joint Expansion)：在分割处自动生成圆滑的重叠像素，防止动画时断裂。
## 2. 右侧属性面板功能
### 部位预设 (Parts Presets)：
   - 一键模板：标准人形（22个部位）、四足动物等。
### 图层细分属性：
   - 边缘羽化 (Feathering)：调节部位边缘平滑度。
   - 扩张像素 (Dilation)：设置关节点处的像素冗余量，用于覆盖旋转空隙。
### 自动网格化 (Auto Mesh)：
   - 顶点密度 (Vertex Density) 调节：控制后续变形的精细度。

# Stage C: 骨骼绑定 (Skeletal Rigging)
 - 此阶段从像素处理转为矢量骨骼逻辑。
## 1. 画布交互
  - 画布交互骨骼绘制：点击创建关节点 (Joint)，拖动连线生成骨骼 (Bone)。
  - 权重可视化：点击骨骼，画布以热力图形式显示受影响的 Mesh 区域（红强蓝弱）。
  - IK 链配置：选择起始和末端关节，一键生成 IK 约束。
## 2. 右侧属性面板功能
### 骨骼层级树 (Bone Hierarchy)：
   - 显示 Root、Spine、Limbs 的父子嵌套关系。
   - 重命名骨骼，设置镜像对称（如 Left_Arm 自动对应 Right_Arm）。
### 权重编辑 (Weight Tools)：
   - 权重画笔：设置强度 (Strength) 和半径。
   - 自动权重计算：基于重心算法一键分配。
### 约束设置：
   - 旋转角度限制 (Rotation Limit)：防止关节反人类折断。

# Stage D: 动画制作 (Animation Timeline)
  - 此阶段进行动态序列的产出。
## 1. 画布交互
  - 姿态调整：直接拖动骨骼末端（IK）或旋转骨骼（FK）来改变角色动作。
  - 关键帧记录：在特定时间点修改姿态，系统自动插值。
  - 洋葱皮预览：显示前 $n$ 帧和后 $n$ 帧的幻影。
## 2. 右侧属性面板功能
### 动画剪辑管理 (Clip Manager)：
   - 新建动画（Walk, Idle, Attack）。
   - 循环播放开关及帧率 (FPS) 设置。
### 关键帧插值 (Easing)：
   - 线性 (Linear)、贝塞尔曲线 (Bezier) 调节运动节奏。
### 导出设置：
   - 格式：GIF, MP4, 或游戏引擎通用的 JSON/Spine 格式。
